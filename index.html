<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rezervace Chromebooků a učeben</title>
    <!-- React + ReactDOM z CDN (bez bundleru) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel kvůli JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-br from-indigo-100 via-fuchsia-100 to-sky-100">
    <div id="root"></div>
    <script type="text/babel">
      // ====== Malé utilitky (čistý JS místo date-fns) ======
      const toISO       = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
      const parseISO    = (s) => { const [y,m,dd] = s.split('-').map(Number); return new Date(y, m-1, dd); };
      const addDays     = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
      const startOfWeek = (d)=>{ const iso = ((d.getDay()||7)); return addDays(new Date(d.getFullYear(),d.getMonth(),d.getDate()), -(iso-1)); };// Po
      const addWeeks    = (d,n)=> addDays(d, n*7);
      const isSameDay   = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
      const getISODay   = (d)=> { const g = d.getDay(); return g===0?7:g; }; // Po=1 ... Ne=7
      const fullDateCz  = (d)=> d.toLocaleDateString('cs-CZ',{ weekday:'long', day:'numeric', month:'long', year:'numeric' });
      const shortDateCz = (d)=> d.toLocaleDateString('cs-CZ',{ day:'numeric', month:'numeric' });

      // ====== Aplikace ======
      const { useState, useEffect, useMemo, useRef } = React;
      const PERIODS = ["0","1","2","3","4","5","6","7","8"]; // uprav dle potřeby
      const STORAGE_KEY = "rezervace-chromebooku-state-v1";
      const uid = (p="id") => `${p}_${Math.random().toString(36).slice(2,10)}`;

      const defaultState = {
        teachers:[{id:uid('t'), name:'Nováková'}, {id:uid('t'), name:'Dvořák'}],
        rooms:[
          {id:uid('r'), name:'IT učebna', floor:'přízemí', code:'IT'},
          {id:uid('r'), name:'Vozík 1', floor:'1. patro', code:'V1'},
          {id:uid('r'), name:'První patro', floor:'1', code:'P1'},
        ],
        reservations:{}, // { 'YYYY-MM-DD': { [roomId]: { [period]: {teacherId, pieces?, note?} } } }
        recurring:[],    // { id, weekday(1-7), roomId, period, teacherId, pieces?, note?, startISO, endISO? }
      };
      const loadState = () => { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState; }catch{ return defaultState; } };
      const saveState = (s) => localStorage.setItem(STORAGE_KEY, JSON.stringify(s));

      function Badge({children, className=''}){
        return <span className={`inline-block text-[10px] px-1.5 py-0.5 rounded ${className}`}>{children}</span>;
      }

      function ReservationDialog({open, onClose, onSave, teachers, initial}){
        const [teacherId, setTeacherId] = useState(initial?.teacherId || (teachers[0]?.id||""));
        const [pieces, setPieces] = useState(initial?.pieces || "");
        const [note, setNote]     = useState(initial?.note || "");
        const [repeat, setRepeat] = useState(false);
        if(!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{initial? 'Upravit rezervaci':'Nová rezervace'}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">✕</button>
              </div>
              <label className="block text-sm mb-2">Učitel/ka
                <select className="w-full border rounded-xl px-3 py-2 mt-1" value={teacherId} onChange={e=>setTeacherId(e.target.value)}>
                  {teachers.map(t=> <option key={t.id} value={t.id}>{t.name}</option>)}
                </select>
              </label>
              <div className="grid grid-cols-2 gap-2">
                <label className="block text-sm">Kusů (volit.)
                  <input className="w-full border rounded-xl px-3 py-2 mt-1" type="number" min="1" value={pieces} onChange={e=>setPieces(e.target.value)} />
                </label>
                <label className="block text-sm">Poznámka (volit.)
                  <input className="w-full border rounded-xl px-3 py-2 mt-1" value={note} onChange={e=>setNote(e.target.value)} />
                </label>
              </div>
              <label className="inline-flex items-center gap-2 text-sm mt-3">
                <input type="checkbox" className="scale-110" checked={repeat} onChange={e=>setRepeat(e.target.checked)} />
                Opakovat každý týden
              </label>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zrušit</button>
                <button onClick={()=>{ onSave({teacherId, pieces:pieces?Number(pieces):undefined, note, repeat}); onClose(); }} className="px-3 py-2 rounded-xl bg-black text-white">Uložit</button>
              </div>
            </div>
          </div>
        );
      }

      function App(){
        const [state, setState] = useState(loadState);
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [dialog, setDialog] = useState(null); // {dateIso, roomId, period, initial?}
        const [showSettings, setShowSettings] = useState(false);
        const datePickerRef = useRef(null);
        useEffect(()=>saveState(state), [state]);

        const selectedIso = toISO(selectedDate);

        // Aplikovat opakované rezervace pro daný den
        const effectivePlan = useMemo(()=>{
          const plan = JSON.parse(JSON.stringify(state.reservations[selectedIso] || {}));
          const weekday = getISODay(selectedDate);
          state.recurring.forEach(r=>{
            if(r.weekday!==weekday) return;
            const startOk = !r.startISO || parseISO(selectedIso) >= parseISO(r.startISO);
            const endOk   = !r.endISO   || parseISO(selectedIso) <= parseISO(r.endISO);
            if(!startOk || !endOk) return;
            plan[r.roomId] ||= {};
            if(!plan[r.roomId][r.period]){
              plan[r.roomId][r.period] = { teacherId:r.teacherId, pieces:r.pieces, note:r.note, recurringId:r.id };
            }
          });
          return plan;
        }, [state, selectedIso, selectedDate]);

        // === Shrnutí pro mini kalendář (jen pracovní dny) ===
        const workweek = useMemo(()=>{
          const start = startOfWeek(selectedDate); // Po
          return [0,1,2,3,4].map(off=> addDays(start, off));
        }, [selectedDate]);

        // Vytvoř detailní seznam náhledů: [{period, code, recurring}]
        function daySummaryDetailed(date){
          const iso = toISO(date);
          const weekday = getISODay(date);
          const items = [];
          const direct = state.reservations[iso] || {};
          Object.entries(direct).forEach(([roomId, slots])=>{
            Object.keys(slots).forEach(period=>{
              items.push({period, code: (state.rooms.find(r=>r.id===roomId)?.code||"?"), recurring:false});
            });
          });
          state.recurring.forEach(r=>{
            if(r.weekday!==weekday) return;
            const startOk = !r.startISO || parseISO(iso) >= parseISO(r.startISO);
            const endOk   = !r.endISO   || parseISO(iso) <= parseISO(r.endISO);
            if(!startOk || !endOk) return;
            items.push({period:r.period, code:(state.rooms.find(x=>x.id===r.roomId)?.code||"?"), recurring:true});
          });
          // seřadit nejdřív podle period a pak podle kódu
          items.sort((a,b)=> Number(a.period)-Number(b.period) || a.code.localeCompare(b.code));
          return items;
        }

        // CRUD: učitelé + učebny
        const addTeacher = (name)=> setState(s=>({...s, teachers:[...s.teachers, {id:uid('t'), name}]}));
        const removeTeacher = (id)=> setState(s=>({...s, teachers:s.teachers.filter(t=>t.id!==id)}));
        const addRoom = (name,floor,code)=> setState(s=>({...s, rooms:[...s.rooms, {id:uid('r'), name, floor, code:code||name.slice(0,2).toUpperCase()}]}));
        const removeRoom = (id)=> setState(s=>({...s, rooms:s.rooms.filter(r=>r.id!==id)}));

        // CRUD: rezervace
        function upsertReservation(dateIso, roomId, period, payload){
          setState(s=>{
            const next = {...s, reservations:{...s.reservations}};
            const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
            day[roomId] ||= {};
            day[roomId][period] = { teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note };
            next.reservations[dateIso] = day;
            if(payload.repeat){
              next.recurring = [...s.recurring, { id:uid('rec'), weekday:getISODay(parseISO(dateIso)), roomId, period, teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note, startISO:dateIso }];
            }
            return next;
          });
        }
        function clearReservation(dateIso, roomId, period){
          setState(s=>{
            const next = {...s, reservations:{...s.reservations}};
            const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
            if(day[roomId]) delete day[roomId][period];
            next.reservations[dateIso] = day; return next;
          });
        }
        function stopRecurring(id){ setState(s=>({...s, recurring:s.recurring.filter(r=>r.id!==id)})); }

        // Form inputs
        const [newTeacher, setNewTeacher] = useState("");
        const [newRoom, setNewRoom] = useState({name:"", floor:"", code:""});

        // --- Pomocné obsluhy ---
        const openDatePicker = ()=> datePickerRef.current && datePickerRef.current.showPicker ? datePickerRef.current.showPicker() : datePickerRef.current.click();
        const onPickDate = (e)=>{ const v=e.target.value; if(v){ setSelectedDate(parseISO(v)); } };

        return (
          <div className="p-4 max-w-7xl mx-auto grid gap-4">
            {/* Horní lišta */}
            <header className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">Rezervace Chromebooků a učeben</h1>
              <div className="flex items-center gap-2">
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,-1))} className="px-3 py-2 rounded-xl border bg-white">◀ Týden</button>
                <button onClick={openDatePicker} className="px-3 py-2 rounded-xl border bg-white">📅 Datum</button>
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,1))} className="px-3 py-2 rounded-xl border bg-white">Týden ▶</button>
                <button onClick={()=>setShowSettings(s=>!s)} className="px-3 py-2 rounded-xl border bg-white">{showSettings? 'Skrýt nastavení':'Nastavení'}</button>
              </div>
            </header>
            {/* Skrytý nativní date-picker */}
            <input ref={datePickerRef} type="date" className="hidden" value={selectedIso} onChange={onPickDate} />

            {/* Pracovní týden (Po–Pá) s přehledem rezervací */}
            <section className="bg-white/80 rounded-2xl p-4">
              <div className="grid grid-cols-5 text-center text-xs font-medium text-gray-600 mb-2">
                {['Po','Út','St','Čt','Pá'].map((n,i)=> <div key={i} className="py-1">{n}</div>)}
              </div>
              <div className="grid grid-cols-5 gap-2">
                {workweek.map(d=>{
                  const sel = isSameDay(d, selectedDate);
                  const items = daySummaryDetailed(d); // [{period,code,recurring}]
                  return (
                    <button key={d.toISOString()} onClick={()=>setSelectedDate(d)}
                      className={`h-28 rounded-2xl border p-2 text-left bg-white hover:shadow ${sel? 'ring-2 ring-fuchsia-400':''}`}>
                      <div className="text-sm font-semibold">{shortDateCz(d)}</div>
                      <div className="mt-1 flex flex-wrap gap-1">
                        {items.length===0 ? (
                          <Badge className="bg-green-100 border border-green-400 text-green-800">volno</Badge>
                        ) : (
                          items.map((it,idx)=> (
                            <Badge key={idx} className={`border ${it.recurring? 'bg-red-100 border-red-400 text-red-800':'bg-red-100 border-red-400 text-red-800'}`}>
                              {it.period}. {it.code}
                            </Badge>
                          ))
                        )}
                      </div>
                    </button>
                  );
                })}
              </div>
            </section>

            {/* CENTRÁLNÍ – Denní plán */}
            <section className="bg-white/80 rounded-2xl p-4">
              <h2 className="text-lg font-semibold mb-2">{fullDateCz(selectedDate)}</h2>
              <div className="overflow-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr>
                      <th className="text-left p-2 sticky left-0 bg-white/90 backdrop-blur z-10">Učebna</th>
                      {PERIODS.map(p=> <th key={p} className="p-2 min-w-28 text-center">{p}. hod.</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {state.rooms.map(room=> (
                      <tr key={room.id} className="odd:bg-white/60 even:bg-white/40">
                        <th className="text-left p-2 sticky left-0 bg-white/80 backdrop-blur z-10">
                          <div className="font-medium">{room.name} <span className="text-xs ml-1 px-1.5 py-0.5 rounded bg-gray-100 border">{room.code}</span></div>
                          <div className="text-xs text-gray-600">{room.floor}</div>
                        </th>
                        {PERIODS.map(p=>{
                          const cell = effectivePlan?.[room.id]?.[p];
                          const isRecurring = !!cell?.recurringId;
                          const baseCls = cell
                            ? (isRecurring ? 'bg-red-100 border-2 border-dashed border-red-500' : 'bg-red-100 border border-red-400')
                            : 'bg-green-100 border border-green-400';
                          return (
                            <td key={p} className="align-top p-1">
                              <div className={`rounded-xl p-2 min-h-16 ${baseCls}`}>
                                {cell ? (
                                  <div className="flex flex-col gap-1">
                                    <div className="font-medium text-red-900 flex items-center gap-2">
                                      {state.teachers.find(t=>t.id===cell.teacherId)?.name || '?' }
                                      {cell.pieces? <Badge className="bg-white/70 border text-xs">{cell.pieces} ks</Badge>:null}
                                      {isRecurring && <Badge className="bg-red-200 border border-red-500 text-red-900">opak.</Badge>}
                                    </div>
                                    {cell.note && <div className="text-xs text-red-800">{cell.note}</div>}
                                    <div className="flex gap-2 mt-1">
                                      {!isRecurring && (
                                        <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=> setDialog({dateIso:selectedIso, roomId:room.id, period:p, initial:cell})}>Upravit</button>
                                      )}
                                      {isRecurring ? (
                                        <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=> stopRecurring(cell.recurringId)}>Zrušit opak.</button>
                                      ) : (
                                        <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=> clearReservation(selectedIso, room.id, p)}>Smazat</button>
                                      )}
                                    </div>
                                  </div>
                                ) : (
                                  <button className="w-full text-left text-xs text-green-900 hover:underline" onClick={()=> setDialog({dateIso:selectedIso, roomId:room.id, period:p})}>+ Přidat</button>
                                )}
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            {/* NASTAVENÍ – skryté/odkryté tlačítkem */}
            {showSettings && (
              <section className="bg-white/80 rounded-2xl p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                {/* Učitelé */}
                <div>
                  <h2 className="text-lg font-semibold mb-2">Učitelé</h2>
                  <div className="flex gap-2 mb-3">
                    <input className="flex-1 border rounded-xl px-3 py-2" placeholder="Jméno a příjmení" value={newTeacher} onChange={e=>setNewTeacher(e.target.value)} />
                    <button onClick={()=>{ if(newTeacher.trim()) { addTeacher(newTeacher.trim()); setNewTeacher(''); } }} className="px-3 py-2 rounded-xl bg-black text-white">Přidat</button>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {state.teachers.map(t=> (
                      <span key={t.id} className="inline-flex items-center gap-2 px-3 py-1 rounded-full border">
                        {t.name}
                        <button className="text-red-600" onClick={()=>removeTeacher(t.id)}>✕</button>
                      </span>
                    ))}
                  </div>
                </div>

                {/* Učebny */}
                <div>
                  <h2 className="text-lg font-semibold mb-2">Učebny / Vozíky</h2>
                  <div className="grid grid-cols-6 gap-2 mb-3">
                    <input className="col-span-3 border rounded-xl px-3 py-2" placeholder="Název" value={newRoom.name} onChange={e=>setNewRoom(v=>({...v, name:e.target.value}))} />
                    <input className="col-span-1 border rounded-xl px-3 py-2" placeholder="Patro" value={newRoom.floor} onChange={e=>setNewRoom(v=>({...v, floor:e.target.value}))} />
                    <input className="col-span-1 border rounded-xl px-3 py-2" placeholder="Zkratka" value={newRoom.code} onChange={e=>setNewRoom(v=>({...v, code:e.target.value}))} />
                    <button className="col-span-1 px-3 py-2 rounded-xl bg-black text-white" onClick={()=>{ if(newRoom.name.trim()) { addRoom(newRoom.name.trim(), newRoom.floor.trim(), newRoom.code.trim()); setNewRoom({name:"", floor:"", code:""}); } }}>Přidat</button>
                  </div>
                  <div className="flex flex-col gap-2">
                    {state.rooms.map(r=> (
                      <div key={r.id} className="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2">
                        <div>
                          <div className="font-medium">{r.name} <span className="text-xs ml-1 px-1.5 py-0.5 rounded bg-gray-100 border">{r.code}</span></div>
                          <div className="text-xs text-gray-600">{r.floor}</div>
                        </div>
                        <button className="p-2 rounded-lg hover:bg-gray-100" onClick={()=>removeRoom(r.id)} title="Odebrat">✕</button>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Opakované rezervace */}
                <div>
                  <h2 className="text-lg font-semibold mb-2">Opakované rezervace</h2>
                  {state.recurring.length===0 && <div className="text-sm text-gray-600">Zatím žádné.</div>}
                  <div className="flex flex-col gap-2">
                    {state.recurring.map(r=> (
                      <div key={r.id} className="flex items-center justify-between rounded-xl border bg-red-50 px-3 py-2">
                        <div className="text-sm">
                          <span className="font-medium">{['Po','Út','St','Čt','Pá','So','Ne'][r.weekday-1]} {r.period}. hod. – {state.rooms.find(x=>x.id===r.roomId)?.name}</span>
                          {' · '}{state.teachers.find(t=>t.id===r.teacherId)?.name}
                          {r.pieces? ` · ${r.pieces} ks`:''}
                          {r.note? ` · ${r.note}`:''}
                          <div className="text-xs text-gray-600">od {r.startISO}</div>
                        </div>
                        <button onClick={()=>stopRecurring(r.id)} className="px-3 py-1 rounded-xl border">Zrušit</button>
                      </div>
                    ))}
                  </div>
                </div>
              </section>
            )}

            {/* Dialog */}
            <ReservationDialog open={!!dialog} onClose={()=>setDialog(null)} teachers={state.teachers} initial={dialog?.initial}
              onSave={(payload)=>{ upsertReservation(dialog.dateIso, dialog.roomId, dialog.period, payload); }} />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
