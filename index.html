<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rezervace Chromebooků a učeben</title>

    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind (dev only) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase compat UMD -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  </head>

  <body class="bg-gradient-to-br from-indigo-100 via-fuchsia-100 to-sky-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // ---------- util ----------
      const toISO = d => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
      const parseISO = s => { const [y,m,dd]=s.split('-').map(Number); return new Date(y, m-1, dd); };
      const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
      const addWeeks = (d,n)=> addDays(d, n*7);
      const startOfWeek = d => { const iso = d.getDay() || 7; return addDays(new Date(d.getFullYear(), d.getMonth(), d.getDate()), -(iso-1)); };
      const isSameDay = (a,b) => a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
      const fullDateCz = d => d.toLocaleDateString('cs-CZ', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      const shortDateCz = d => d.toLocaleDateString('cs-CZ', { day:'numeric', month:'numeric' });
      const cmpISO = (a,b)=>{ const A=parseISO(a), B=parseISO(b); if (A<B) return -1; if (A>B) return 1; return 0; };
      const diffDays = (aISO,bISO)=> Math.round((parseISO(aISO) - parseISO(bISO)) / 86400000);
      const schoolYearEndISO = (date)=>{
        const y = date.getFullYear(), m = date.getMonth();
        const endYear = (m >= 8 ? y+1 : y);
        return new Date(endYear, 5, 30).toISOString().slice(0,10);
      };
      const PERIODS = ["0","1","2","3","4","5","6","7","8"];
      const Badge=({children,className=''})=> <span className={`inline-block text-[10px] px-1.5 py-0.5 rounded ${className}`}>{children}</span>;
      const CELLCLS = { free:'bg-green-100 border border-green-400', single:'bg-red-100 border border-red-400', recAmber:'bg-amber-100 border border-amber-400', recBlue:'bg-blue-100 border border-blue-400' };

      // ---------- Firebase init ----------
      const firebaseConfig = {
        apiKey: "AIzaSyCJHjEVG_BCjTnHDSQ07Bym-XGAs1k_fXw",
        authDomain: "rezervace-e7631.firebaseapp.com",
        projectId: "rezervace-e7631",
        storageBucket: "rezervace-e7631.firebasestorage.app",
        messagingSenderId: "331678302051",
        appId: "1:331678302051:web:6662a934039c9667629d56"
      };
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db   = firebase.firestore();

      // ---------- Dialogy ----------
      function DateModal({open,valueISO,onClose,onChange}){
        if(!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">Vyber datum</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">✕</button>
              </div>
              <input type="date" className="w-full border rounded-xl px-3 py-2" value={valueISO} onChange={e=>onChange(e.target.value)} />
              <div className="flex justify-end mt-3"><button onClick={onClose} className="px-3 py-2 rounded-xl border">Hotovo</button></div>
            </div>
          </div>
        );
      }

      function RoomDialog({open,initial,onClose,onSave}){
        const [name,setName]=useState(""),[floor,setFloor]=useState(""),[code,setCode]=useState(""),
              [type,setType]=useState("room"),[max,setMax]=useState(1);
        useEffect(()=>{ if(open){ setName(initial?.name||""); setFloor(initial?.floor||""); setCode(initial?.code||""); setType(initial?.type||"room"); setMax(initial?.max||1);} },[open,initial]);
        if(!open) return null; const isEquip = type === "equipment";
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{initial?"Upravit místnost":"Nová místnost"}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">✕</button>
              </div>
              <div className="grid grid-cols-6 gap-2">
                <input className="col-span-3 border rounded-xl px-3 py-2" placeholder="Název" value={name} onChange={e=>setName(e.target.value)} />
                <input className="col-span-2 border rounded-xl px-3 py-2" placeholder="Patro" value={floor} onChange={e=>setFloor(e.target.value)} />
                <input className="col-span-1 border rounded-xl px-3 py-2" placeholder="Zkratka" value={code} onChange={e=>setCode(e.target.value)} />
                <select className="col-span-3 border rounded-xl px-3 py-2" value={type} onChange={e=>setType(e.target.value)}>
                  <option value="room">Učebna</option>
                  <option value="equipment">Pomůcka</option>
                </select>
                <input className="col-span-3 border rounded-xl px-3 py-2" type="number" min="1" placeholder="Max. kusů" value={max} onChange={e=>setMax(Number(e.target.value)||1)} disabled={!isEquip}/>
              </div>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zrušit</button>
                <button
                  onClick={()=>{
                    const payload = { name: name.trim(), floor: floor.trim(), code: code.trim(), type };
                    if (type === "equipment") { payload.max = Math.max(1, Number(max)||1); }
                    onSave(payload);
                  }}
                  className="px-3 py-2 rounded-xl bg-black text-white"
                >Uložit</button>
              </div>
            </div>
          </div>
        );
      }

      function ReservationDialog({open,onClose,onSave,teachers,initial,room,editingRecurring,isAdmin,currentUserId}){
        const [teacherId,setTeacherId]=useState(initial?.teacherId || (isAdmin ? (teachers.find(t=>t.id===currentUserId)?.id || teachers[0]?.id || "") : (currentUserId || "")));
        const defaultPieces = room?.type==="equipment" ? (room?.max||1) : 1;
        const [pieces,setPieces]=useState(initial?.pieces ?? defaultPieces);
        const [note,setNote]=useState(initial?.note||"");

        const isRoom = room?.type==="room";
        const [repeatOn,setRepeatOn]=useState(!!editingRecurring);
        const [repeatMode,setRepeatMode]=useState(editingRecurring?.mode || 'until');
        const [repeatWeeks,setRepeatWeeks]=useState(editingRecurring?.weeks || 4);
        const [allowElsewhere,setAllowElsewhere]=useState(!!editingRecurring?.allowElsewhere && isRoom);

        useEffect(()=>{ if(open){ setPieces(initial?.pieces ?? defaultPieces); setRepeatOn(!!editingRecurring); setRepeatMode(editingRecurring?.mode||'until'); setRepeatWeeks(editingRecurring?.weeks||4); setAllowElsewhere(!!editingRecurring?.allowElsewhere && isRoom);} },[open,initial,room,editingRecurring]);
        useEffect(()=>{ 
          if(open && !initial?.teacherId){
            setTeacherId(isAdmin ? (currentUserId || teachers[0]?.id || "") : (currentUserId || ""));
          }
        },[open,teachers,currentUserId,isAdmin,initial]);

        if(!open) return null;
        const isEquip = room?.type==="equipment";
        const maxPieces = Math.max(1, room?.max||1);

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{editingRecurring?"Upravit opakování":"Nová rezervace"}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">✕</button>
              </div>

              {isAdmin ? (
                <label className="block text-sm mb-2">Učitel/ka
                  <select className="w-full border rounded-xl px-3 py-2 mt-1" value={teacherId} onChange={e=>setTeacherId(e.target.value)}>
                    {teachers.map(t=>(
                      <option key={t.id} value={t.id}>{t.name}</option>
                    ))}
                  </select>
                </label>
              ) : (
                <div className="text-sm mb-2">
                  <div className="text-gray-600 mb-1">Učitel/ka</div>
                  <div className="px-3 py-2 border rounded-xl bg-gray-50">{teachers.find(t=>t.id===currentUserId)?.name || '—'}</div>
                </div>
              )}

              {isEquip && (
                <div className="mb-2">
                  <div className="flex justify-between text-xs text-gray-600"><span>Počet kusů</span><span>{pieces} / {maxPieces}</span></div>
                  <input type="range" min="1" max={maxPieces} value={pieces} onChange={e=>setPieces(Number(e.target.value))} className="w-full"/>
                </div>
              )}

              <label className="block text-sm">Poznámka (volit.)
                <input className="w-full border rounded-xl px-3 py-2 mt-1" value={note} onChange={e=>setNote(e.target.value)}/>
              </label>

              <div className="mt-4 border-t pt-3">
                <div className="text-sm font-medium mb-2">Opakovat každý týden</div>
                <div className="inline-flex rounded-xl border overflow-hidden mb-3">
                  <button type="button" className={`px-3 py-1 ${!repeatOn ? 'bg-black text-white' : 'bg-white'}`} onClick={()=>setRepeatOn(false)}>Vypnuto</button>
                  <button type="button" className={`px-3 py-1 ${ repeatOn ? 'bg-black text-white' : 'bg-white'}`} onClick={()=>setRepeatOn(true)}>Zapnuto</button>
                </div>

                {repeatOn && (
                  <div className="space-y-3">
                    <div className="text-sm">
                      <div className="mb-1">Délka opakování</div>
                      <div className="inline-flex rounded-xl border overflow-hidden">
                        <button type="button" className={`px-3 py-1 ${repeatMode==='until' ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatMode('until')}>Do konce roku</button>
                        <button type="button" className={`px-3 py-1 ${repeatMode==='weeks' ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatMode('weeks')}>Počet týdnů</button>
                      </div>
                    </div>

                    {repeatMode==='weeks' && (
                      <label className="text-sm block">
                        <span className="block mb-1">Počet týdnů</span>
                        <input type="number" min="1" max="40" className="w-full border rounded-xl px-3 py-2"
                          value={repeatWeeks} onChange={(e)=>setRepeatWeeks(Math.max(1, Math.min(40, Number(e.target.value)||1)))} />
                      </label>
                    )}

                    {isRoom && (
                      <div className="text-sm">
                        <div className="mb-1">Místo konání</div>
                        <div className="inline-flex rounded-xl border overflow-hidden">
                          <button type="button" className={`px-3 py-1 ${!allowElsewhere ? 'bg-black text-white':'bg-white'}`} onClick={()=>setAllowElsewhere(false)}>Hodina musí být v učebně</button>
                          <button type="button" className={`px-3 py-1 ${ allowElsewhere ? 'bg-black text-white':'bg-white'}`} onClick={()=>setAllowElsewhere(true)}>Hodina může být i jinde</button>
                        </div>
                        <div className="text-xs text-gray-600 mt-1">
                          {allowElsewhere ? 'Opakované rezervace budou modře.' : 'Opakované rezervace budou žlutě.'}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zrušit</button>
                <button
                  onClick={()=>{
                    onSave({
                      teacherId,
                      pieces: isEquip ? Number(pieces) : undefined,
                      note,
                      repeat: repeatOn ? {
                        mode: repeatMode,
                        weeks: repeatWeeks || undefined,
                        allowElsewhere: isRoom ? allowElsewhere : undefined,
                      } : null,
                    });
                    onClose();
                  }}
                  className="px-3 py-2 rounded-xl bg-black text-white"
                >Uložit</button>
              </div>
            </div>
          </div>
        );
      }

      // ---------- App ----------
      function App(){
        const [selectedDate,setSelectedDate]=useState(new Date());
        const selectedIso = toISO(selectedDate);

        // auth & role
        const [authUser,setAuthUser]=useState(null);
        const [me,setMe]=useState(null);
        const [loadingAuth,setLoadingAuth]=useState(true);
        const [waitingApproval,setWaitingApproval]=useState(false);

        // data
        const [rooms,setRooms]=useState([]);
        const [teachers,setTeachers]=useState([]);
        const [reservations,setReservations]=useState({});
        const [recurring,setRecurring]=useState([]);
        const [allUsers,setAllUsers]=useState([]);
        const [allowlist,setAllowlist]=useState([]);
        const [showSettings,setShowSettings]=useState(false);
        const [dateModal,setDateModal]=useState(false);
        const [editingRoom,setEditingRoom]=useState(null);
        const [creatingRoom,setCreatingRoom]=useState(false);
        const [dialog,setDialog]=useState(null);

        // moje přehledy (uživatel)
        const [mySingles,setMySingles]=useState([]);
        const [myRecurring,setMyRecurring]=useState([]);
        const [showMySingles,setShowMySingles]=useState(false);
        const [showMyRecurring,setShowMyRecurring]=useState(false);

        // DnD – pouze UI
        const [dragRoomId,setDragRoomId]=useState(null);
        const [isDraggingRoom,setIsDraggingRoom]=useState(false);

        // hooky, které musí být vždy volané
        const workweek = useMemo(()=>{
          const start = startOfWeek(selectedDate);
          return [0,1,2,3,4].map(off=>addDays(start,off));
        },[selectedDate]);

        // Range ISO pro aktuální týden
        const weekStartIso = toISO(startOfWeek(selectedDate));
        const weekEndIso = toISO(addDays(startOfWeek(selectedDate), 4));

        // auth
        useEffect(()=>{
          const unsub = auth.onAuthStateChanged(async (u)=>{
            setAuthUser(u);
            if(!u){ setMe(null); setWaitingApproval(false); setLoadingAuth(false); return; }

            const ref = db.collection('users').doc(u.uid);
            const snap = await ref.get();
            const isBootstrapAdmin = (u.email === 'dgunka@gymnaziumbma.cz');

            if(!snap.exists){
              let preapproved=false;
              try{
                const allowSnap = await db.collection('allowlist').doc((u.email||'').toLowerCase()).get();
                preapproved = allowSnap.exists;
              }catch{}
              await ref.set({
                email: u.email || '',
                displayName: u.displayName || (u.email? u.email.split('@')[0] : 'Uživatel'),
                isAdmin: isBootstrapAdmin,
                approved: isBootstrapAdmin || preapproved,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              }, {merge:true});
            } else if (isBootstrapAdmin){
              await ref.set({ isAdmin:true, approved:true }, {merge:true});
            }

            const snap2 = await ref.get();
            const data = snap2.data();
            setMe(data);
            setWaitingApproval(!data.approved);
            setLoadingAuth(false);
          });
          return ()=>unsub&&unsub();
        },[]);

        // users -> teachers
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('users').onSnapshot(q=>{
            const list = q.docs.map(d=>({id:d.id, ...d.data()}));
            setAllUsers(list);
            const allowed = list.filter(u=>u.approved);
            setTeachers(allowed.map(u=>({id:u.id, name:u.displayName || u.email})));
          });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval]);

        // allowlist (pro zobrazení v nastavení)
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('allowlist').onSnapshot(q=>{
            setAllowlist(q.docs.map(d=>({id:d.id, ...d.data()})));
          });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval]);

        // rooms
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('rooms').orderBy('name','asc').onSnapshot(q=>{
            setRooms(q.docs.map(d=>({id:d.id, ...d.data()})));
          });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval]);

        // reservations (jen vybraný den pro tabulku níže)
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('reservations').where('dateISO','==',selectedIso).onSnapshot(q=>{
            const dayMap = {};
            q.docs.forEach(d=>{
              const r = d.data();
              dayMap[r.roomId] ??= {};
              dayMap[r.roomId][r.period] = { teacherId:r.teacherId, pieces:r.pieces, note:r.note, createdBy:r.createdBy, recurringId:r.recurringId, allowElsewhere:r.allowElsewhere };
            });
            setReservations(dayMap);
          });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval, selectedIso]);

        // recurring (globální)
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('recurring').onSnapshot(q=>{
            setRecurring(q.docs.map(d=>({id:d.id, ...d.data()})));
          });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval]);

        // --- NOVÉ: Singles pro celý týden do horního náhledu ---
        const [weeklySingles,setWeeklySingles]=useState({});
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const unsub = db.collection('reservations')
            .where('dateISO','>=',weekStartIso)
            .where('dateISO','<=',weekEndIso)
            .onSnapshot(q=>{
              const map = {};
              q.docs.forEach(d=>{
                const r = d.data();
                const iso = r.dateISO;
                map[iso] ??= [];
                map[iso].push({ period: r.period, roomId: r.roomId });
              });
              setWeeklySingles(map);
            });
          return ()=>unsub&&unsub();
        },[!!authUser, !!me, waitingApproval, weekStartIso, weekEndIso]);

        // occursOn
        function occursOn(dateISO, rec){
          if(cmpISO(dateISO, rec.startISO) < 0) return false;
          const days = diffDays(dateISO, rec.startISO);
          if(days % 7 !== 0) return false;
          if(rec.mode==='weeks' && typeof rec.weeks==='number'){
            const weekIndex = Math.floor(days/7);
            return weekIndex >= 0 && weekIndex < rec.weeks;
          }
          if(rec.endISO && cmpISO(dateISO, rec.endISO) > 0) return false;
          return true;
        }

        // effective plan
        const effectivePlan = useMemo(()=>{
          const plan = JSON.parse(JSON.stringify(reservations||{}));
          (recurring||[]).forEach(r=>{
            if(!occursOn(selectedIso, r)) return;
            plan[r.roomId] ??= {};
            if(!plan[r.roomId][r.period]){
              plan[r.roomId][r.period] = {
                teacherId:r.teacherId, pieces:r.pieces, note:r.note,
                recurringId:r.id, allowElsewhere: !!r.allowElsewhere, createdBy:r.createdBy
              };
            }
          });
          return plan;
        },[reservations, recurring, selectedIso]);

        // CRUD rooms
        const addRoom = async payload=>{
          const body = { name:payload.name, floor:payload.floor, code:payload.code, type:payload.type };
          if(payload.type==='equipment'){ body.max = Math.max(1, Number(payload.max)||1); }
          await db.collection('rooms').add(body);
        };
        const updateRoom = async (id, patch)=>{
          const body = {...patch};
          if(body.type !== 'equipment'){ delete body.max; }
          await db.collection('rooms').doc(id).set(body, {merge:true});
        };
        const removeRoom = async id => { await db.collection('rooms').doc(id).delete(); };

        // CRUD reservations/recurring
        async function upsertReservation(dateIso, roomId, period, payload, editingRecurringId=null){
          const userId = authUser?.uid || 'unknown';
          const teacherForSave = (me?.isAdmin) ? payload.teacherId : userId;
          if(payload.repeat || editingRecurringId){
            const origSnap = editingRecurringId ? await db.collection('recurring').doc(editingRecurringId).get() : null;
            const seriesStartISO = (origSnap && origSnap.exists) ? origSnap.data().startISO : dateIso;

            if(payload.repeat){
              const q = await db.collection('reservations').where('dateISO','==',dateIso).where('roomId','==',roomId).where('period','==',period).get();
              q.forEach(d=>d.ref.delete());

              const rec = {
                roomId, period,
                teacherId: teacherForSave,
                startISO: seriesStartISO,
                note: payload.note || '',
                createdBy: userId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              };
              if(typeof payload.pieces === 'number') rec.pieces = payload.pieces;
              if(payload.repeat.mode === 'until'){
                rec.mode = 'until';
                rec.endISO = schoolYearEndISO(parseISO(seriesStartISO));
              } else {
                const w = Math.max(1, Number(payload.repeat.weeks)||1);
                rec.mode = 'weeks';
                rec.weeks = w;
                rec.endISO = toISO(addDays(parseISO(seriesStartISO), (w-1)*7));
              }
              if(typeof payload.repeat.allowElsewhere !== 'undefined'){
                rec.allowElsewhere = !!payload.repeat.allowElsewhere;
              }

              if(editingRecurringId){
                await db.collection('recurring').doc(editingRecurringId).set(rec, {merge:true});
              }else{
                rec.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('recurring').add(rec);
              }
            } else {
              if(editingRecurringId){ await db.collection('recurring').doc(editingRecurringId).delete(); }
              const single = {
                dateISO: dateIso, roomId, period,
                teacherId: teacherForSave,
                note: payload.note || '',
                createdBy: userId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              };
              if(typeof payload.pieces === 'number') single.pieces = payload.pieces;
              await db.collection('reservations').add(single);
            }
          } else {
            const single = {
              dateISO: dateIso, roomId, period,
              teacherId: teacherForSave,
              note: payload.note || '',
              createdBy: userId,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            if(typeof payload.pieces === 'number') single.pieces = payload.pieces;
            await db.collection('reservations').add(single);
          }
        }

        async function clearReservation(dateIso, roomId, period){
          const q = await db.collection('reservations')
            .where('dateISO','==',dateIso).where('roomId','==',roomId).where('period','==',period).get();
          for(const d of q.docs) await d.ref.delete();
        }
        async function stopRecurring(id){ await db.collection('recurring').doc(id).delete(); }

        // Admin helper: smazat uživatele + jeho data
        async function adminDeleteUserAndData(user){
          if(!me?.isAdmin) return;
          const uid = user.id;
          const resSnap = await db.collection('reservations').where('createdBy','==',uid).get();
          const recSnap = await db.collection('recurring').where('createdBy','==',uid).get();
          const batch = db.batch();
          resSnap.forEach(doc=>batch.delete(doc.ref));
          recSnap.forEach(doc=>batch.delete(doc.ref));
          await batch.commit();
          try {
            await db.collection('users').doc(uid).delete();
          } catch(e){
            alert('Uživatelovy rezervace byly smazány, ale smazání profilu selhalo (pravidla). Doplňte prosím pravidlo delete v /users.\n\nChyba: '+e.message);
          }
        }

        const canUseApp = !!authUser && !!me && me.approved;
        const isAdmin   = !!me?.isAdmin;

        const openCell = (room, period)=>{
          const cell = effectivePlan?.[room.id]?.[p];
          const ownerId = cell?.createdBy;
          const canEdit = !cell || isAdmin || (ownerId && authUser?.uid === ownerId);
          if(!canEdit && cell) return;
          if(cell){
            if(cell.recurringId){
              const rec = recurring.find(r=>r.id===cell.recurringId);
              setDialog({dateIso:selectedIso, roomId:room.id, period, initial:cell, editingRecurringId:rec?.id});
            } else {
              setDialog({dateIso:selectedIso, roomId:room.id, period, initial:cell});
            }
          } else {
            setDialog({dateIso:selectedIso, roomId:room.id, period});
          }
        };

        // ---------- moje seznamy (jen pokud je uživatel schválen) ----------
        useEffect(()=>{
          if(!authUser || !me || waitingApproval) return;
          const uid = authUser.uid;

          // Bez orderBy => nepotřebuje composite index
          const unsub1 = db.collection('reservations').where('createdBy','==',uid).onSnapshot(q=>{
            const arr = q.docs.map(d=>({id:d.id, ...d.data()}));
            arr.sort((a,b)=> (a.dateISO||'').localeCompare(b.dateISO||'') || String(a.period||'').localeCompare(String(b.period||'')));
            setMySingles(arr);
          });

          const unsub2 = db.collection('recurring').where('createdBy','==',uid).onSnapshot(q=>{
            const arr = q.docs.map(d=>({id:d.id, ...d.data()}));
            arr.sort((a,b)=> (a.startISO||'').localeCompare(b.startISO||'') || String(a.period||'').localeCompare(String(b.period||'')));
            setMyRecurring(arr);
          });

          return ()=>{ unsub1&&unsub1(); unsub2&&unsub2(); };
        },[!!authUser, !!me, waitingApproval]);

        // ---------- podmíněné obrazovky (po VŠECH hookách) ----------
        if(loadingAuth){
          return <div className="max-w-3xl mx-auto p-8">Načítám přihlášení…</div>;
        }
        if(!authUser){
          return (
            <div className="min-h-[70vh] flex items-center justify-center p-6">
              <div className="bg-white/80 rounded-2xl shadow p-6 max-w-md w-full">
                <h1 className="text-2xl font-bold mb-4">Rezervace Chromebooků a učeben</h1>
                <p className="mb-4 text-gray-700">Pro pokračování se přihlas svým Google účtem.</p>
                <button className="px-4 py-2 rounded-xl bg-black text-white w-full" onClick={()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())}>Přihlásit se Googlem</button>
              </div>
            </div>
          );
        }
        if(authUser && !canUseApp){
          return (
            <div className="min-h-[70vh] flex items-center justify-center p-6">
              <div className="bg-white/80 rounded-2xl shadow p-6 max-w-md w-full">
                <h1 className="text-2xl font-bold mb-2">Účet čeká na schválení</h1>
                <p className="text-gray-700">Tento účet zatím není schválený administrátorem.</p>
                <div className="mt-4 text-sm text-gray-600">Přihlášen: {authUser.email}</div>
                <div className="mt-6"><button className="px-3 py-2 rounded-xl border" onClick={()=>auth.signOut()}>Odhlásit</button></div>
              </div>
            </div>
          );
        }

        // ---------- hlavní UI ----------
        return (
          <div className="p-4 max-w-7xl mx-auto grid gap-4">
            <header className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">Rezervace Chromebooků a učeben</h1>
              <div className="flex items-center gap-2">
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,-1))} className="px-3 py-2 rounded-xl border bg-white">◀ Týden</button>
                <button onClick={()=>setDateModal(true)} className="px-3 py-2 rounded-xl border bg-white">📅 Datum</button>
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,1))} className="px-3 py-2 rounded-xl border bg-white">Týden ▶</button>
                {isAdmin && (<button onClick={()=>setShowSettings(s=>!s)} className="px-3 py-2 rounded-xl border bg-white">{showSettings?'Skrýt nastavení':'Nastavení'}</button>)}
                <button onClick={()=>auth.signOut()} className="px-3 py-2 rounded-xl border bg-white">Odhlásit</button>
              </div>
            </header>

            <DateModal open={dateModal} valueISO={toISO(selectedDate)} onClose={()=>setDateModal(false)} onChange={(v)=>v&&setSelectedDate(parseISO(v))}/>

            {/* ... (zbytek UI zůstává stejný jako v předchozí verzi; kvůli délce vynecháno) ... */}

            {/* Moje přehledy */}
            {!isAdmin && (
              <section className="bg-white/80 rounded-2xl p-4 space-y-4">
                <div>
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>setShowMyRecurring(v=>!v)}>
                    {showMyRecurring ? 'Skrýt' : 'Zobrazit'} moje opakované rezervace
                  </button>
                  {showMyRecurring && (
                    <div className="mt-3 space-y-2">
                      {myRecurring.length===0 ? <div className="text-sm text-gray-600">Žádné opakované rezervace.</div>
                        : myRecurring.map(r=>(
                          <div key={r.id} className="rounded-xl border px-3 py-2" style={{backgroundColor: r.allowElsewhere ? 'rgba(191,219,254,0.5)' : 'rgba(253,230,138,0.5)'}}>
                            <div className="text-sm">
                              <span className="font-medium">{rooms.find(x=>x.id===r.roomId)?.name || '—'}</span>
                              {' · hod. '}{r.period}
                              {typeof r.pieces==='number' ? ` · ${r.pieces} ks` : ''}
                              {r.note ? ` · ${r.note}` : ''}
                              <div className="text-xs text-gray-600">
                                {r.mode==='weeks' ? `od ${r.startISO} (${r.weeks} týdnů)` : `od ${r.startISO} do ${r.endISO}`}
                              </div>
                            </div>
                          </div>
                        ))
                      }
                    </div>
                  )}
                </div>

                <div>
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>setShowMySingles(v=>!v)}>
                    {showMySingles ? 'Skrýt' : 'Zobrazit'} moje jednorázové rezervace
                  </button>
                  {showMySingles && (
                    <div className="mt-3 space-y-2">
                      {mySingles.length===0 ? <div className="text-sm text-gray-600">Žádné jednorázové rezervace.</div>
                        : mySingles.map(s=>(
                          <div key={s.id} className="rounded-xl border px-3 py-2 bg-white">
                            <div className="text-sm">
                              <span className="font-medium">{rooms.find(x=>x.id===s.roomId)?.name || '—'}</span>
                              {' · '}{s.dateISO}{' · hod. '}{s.period}
                              {typeof s.pieces==='number' ? ` · ${s.pieces} ks` : ''}
                              {s.note ? ` · ${s.note}` : ''}
                            </div>
                          </div>
                        ))
                      }
                    </div>
                  )}
                </div>
              </section>
            )}

          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
