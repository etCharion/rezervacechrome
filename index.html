<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rezervace Chromebooků a učeben</title>
    <!-- React + ReactDOM z CDN (bez bundleru) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel kvůli JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-br from-indigo-100 via-fuchsia-100 to-sky-100">
    <div id="root"></div>
    <script type="text/babel">
      // ====== Malé utilitky (čistý JS místo date-fns) ======
      const toISO       = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
      const parseISO    = (s) => { const [y,m,dd] = s.split('-').map(Number); return new Date(y, m-1, dd); };
      const addDays     = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
      const startOfWeek = (d)=>{ const iso = ((d.getDay()||7)); return addDays(new Date(d.getFullYear(),d.getMonth(),d.getDate()), -(iso-1)); };// Po
      const addWeeks    = (d,n)=> addDays(d, n*7);
      const startOfMonth= (d)=> new Date(d.getFullYear(), d.getMonth(), 1);
      const endOfMonth  = (d)=> new Date(d.getFullYear(), d.getMonth()+1, 0);
      const addMonths   = (d,n)=> new Date(d.getFullYear(), d.getMonth()+n, d.getDate());
      const isSameDay   = (a,b)=> a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
      const getISODay   = (d)=> { const g = d.getDay(); return g===0?7:g; }; // Po=1 ... Ne=7
      const fullDateCz  = (d)=> d.toLocaleDateString('cs-CZ',{ weekday:'long', day:'numeric', month:'long', year:'numeric' });
      const shortDateCz = (d)=> d.toLocaleDateString('cs-CZ',{ day:'numeric', month:'numeric' });

      // ====== Aplikace ======
      const { useState, useEffect, useMemo, useRef } = React;
      const PERIODS = ["0","1","2","3","4","5","6","7","8"]; // uprav dle potřeby
      const STORAGE_KEY = "rezervace-chromebooku-state-v1";
      const uid = (p="id") => `${p}_${Math.random().toString(36).slice(2,10)}`;

      const defaultState = {
        teachers:[{id:uid('t'), name:'Nováková'}, {id:uid('t'), name:'Dvořák'}],
        rooms:[
          {id:uid('r'), name:'IT učebna', floor:'přízemí', code:'IT'},
          {id:uid('r'), name:'Vozík 1', floor:'1. patro', code:'V1'},
          {id:uid('r'), name:'Druhé patro', floor:'2. patro', code:'2P'},
        ],
        reservations:{}, // { 'YYYY-MM-DD': { [roomId]: { [period]: {teacherId, pieces?, note?} } } }
        recurring:[],    // { id, weekday(1-7), roomId, period, teacherId, pieces?, note?, startISO, endISO? }
      };
      const loadState = () => { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState; }catch{ return defaultState; } };
      const saveState = (s) => localStorage.setItem(STORAGE_KEY, JSON.stringify(s));

      function Badge({children, className=''}){
        return <span className={`inline-block text-[10px] px-1.5 py-0.5 rounded ${className}`}>{children}</span>;
      }

      function ReservationDialog({open, onClose, onSave, teachers, initial}){
        const [teacherId, setTeacherId] = useState(initial?.teacherId || (teachers[0]?.id||""));
        const [pieces, setPieces] = useState(initial?.pieces || "");
        const [note, setNote]     = useState(initial?.note || "");
        const [repeat, setRepeat] = useState(false);
        if(!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{initial? 'Upravit rezervaci':'Nová rezervace'}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">✕</button>
              </div>
              <label className="block text-sm mb-2">Učitel/ka
                <select className="w-full border rounded-xl px-3 py-2 mt-1" value={teacherId} onChange={e=>setTeacherId(e.target.value)}>
                  {teachers.map(t=> <option key={t.id} value={t.id}>{t.name}</option>)}
                </select>
              </label>
              <div className="grid grid-cols-2 gap-2">
                <label className="block text-sm">Kusů (volit.)
                  <input className="w-full border rounded-xl px-3 py-2 mt-1" type="number" min="1" value={pieces} onChange={e=>setPieces(e.target.value)} />
                </label>
                <label className="block text-sm">Poznámka (volit.)
                  <input className="w-full border rounded-xl px-3 py-2 mt-1" value={note} onChange={e=>setNote(e.target.value)} />
                </label>
              </div>
              <label className="inline-flex items-center gap-2 text-sm mt-3">
                <input type="checkbox" className="scale-110" checked={repeat} onChange={e=>setRepeat(e.target.checked)} />
                Opakovat každý týden
              </label>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zrušit</button>
                <button onClick={()=>{ onSave({teacherId, pieces:pieces?Number(pieces):undefined, note, repeat}); onClose(); }} className="px-3 py-2 rounded-xl bg-black text-white">Uložit</button>
              </div>
            </div>
          </div>
        );
      }

      function App(){
        const [state, setState] = useState(loadState);
        const [selectedDate, setSelectedDate] = useState(new Date());
        const [dialog, setDialog] = useState(null); // {dateIso, roomId, period, initial?}
        const [showSettings, setShowSettings] = useState(false);
        const datePickerRef = useRef(null);
        useEffect(()=>saveState(state), [state]);

        const selectedIso = toISO(selectedDate);

        // Aplikovat opakované rezervace pro daný den
        const effectivePlan = useMemo(()=>{
          const plan = JSON.parse(JSON.stringify(state.reservations[selectedIso] || {}));
          const weekday = getISODay(selectedDate);
          state.recurring.forEach(r=>{
            if(r.weekday!==weekday) return;
            const startOk = !r.startISO || parseISO(selectedIso) >= parseISO(r.startISO);
            const endOk   = !r.endISO   || parseISO(selectedIso) <= parseISO(r.endISO);
            if(!startOk || !endOk) return;
            plan[r.roomId] ||= {};
            if(!plan[r.roomId][r.period]){
              plan[r.roomId][r.period] = { teacherId:r.teacherId, pieces:r.pieces, note:r.note, recurringId:r.id };
            }
          });
          return plan;
        }, [state, selectedIso, selectedDate]);

        // === Shrnutí pro mini kalendář (jen pracovní dny) ===
        const workweek = useMemo(()=>{
          const start = startOfWeek(selectedDate); // Po
          return [0,1,2,3,4].map(off=> addDays(start, off));
        }, [selectedDate]);

        // Vytvoř detailní seznam náhledů: [{period, code, recurring}]
        function daySummaryDetailed(date){
          const iso = toISO(date);
          const weekday = getISODay(date);
          const items = [];
          const direct = state.reservations[iso] || {};
          Object.entries(direct).forEach(([roomId, slots])=>{
            Object.keys(slots).forEach(period=>{
              items.push({period, code: (state.rooms.find(r=>r.id===roomId)?.code||"?"), recurring:false});
            });
          });
          state.recurring.forEach(r=>{
            if(r.weekday!==weekday) return;
            const startOk = !r.startISO || parseISO(iso) >= parseISO(r.startISO);
            const endOk   = !r.endISO   || parseISO(iso) <= parseISO(r.endISO);
            if(!startOk || !endOk) return;
            items.push({period:r.period, code:(state.rooms.find(x=>x.id===r.roomId)?.code||"?"), recurring:true});
          });
          // seřadit nejdřív podle period a pak podle kódu
          items.sort((a,b)=> Number(a.period)-Number(b.period) || a.code.localeCompare(b.code));
          return items;
        }

        // CRUD: učitelé + učebny
        const addTeacher = (name)=> setState(s=>({...s, teachers:[...s.teachers, {id:uid('t'), name}]}));
        const removeTeacher = (id)=> setState(s=>({...s, teachers:s.teachers.filter(t=>t.id!==id)}));
        const addRoom = (name,floor,code)=> setState(s=>({...s, rooms:[...s.rooms, {id:uid('r'), name, floor, code:code||name.slice(0,2).toUpperCase()}]}));
        const removeRoom = (id)=> setState(s=>({...s, rooms:s.rooms.filter(r=>r.id!==id)}));

        // CRUD: rezervace
        function upsertReservation(dateIso, roomId, period, payload){
          setState(s=>{
            const next = {...s, reservations:{...s.reservations}};
            const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
            day[roomId] ||= {};
            day[roomId][period] = { teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note };
            next.reservations[dateIso] = day;
            if(payload.repeat){
              next.recurring = [...s.recurring, { id:uid('rec'), weekday:getISODay(parseISO(dateIso)), roomId, period, teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note, startISO:dateIso }];
            }
            return next;
          });
        }
        function clearReservation(dateIso, roomId, period){
          setState(s=>{
            const next = {...s, reservations:{...s.reservations}};
            const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
            if(day[roomId]) delete day[roomId][period];
            next.reservations[dateIso] = day; return next;
          });
        }
        function stopRecurring(id){ setState(s=>({...s, recurring:s.recurring.filter(r=>r.id!==id)})); }

        // Form inputs
        const [newTeacher, setNewTeacher] = useState("");
        const [newRoom, setNewRoom] = useState({name:"", floor:"", code:""});

        // --- Pomocné obsluhy ---
        const openDatePicker = ()=> datePickerRef.current && datePickerRef.current.showPicker ? datePickerRef.current.showPicker() : datePickerRef.current.click();
        const onPickDate = (e)=>{ const v=e.target.value; if(v){ setSelectedDate(parseISO(v)); } };

        return (
          <div className="p-4 max-w-7xl mx-auto grid gap-4">
            {/* Horní lišta */}
            <header className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">Rezervace Chromebooků a učeben</h1>
              <div className="flex items-center gap-2">
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,-1))} className="px-3 py-2 rounded-xl border bg-white">◀ Týden</button>
                <button onClick={
