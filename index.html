<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rezervace Chromebook≈Ø a uƒçeben</title>

    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel pro JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase (compat) ‚Äì M≈Æ≈ΩE≈† NECHAT, i kdy≈æ nepou≈æije≈° online re≈æim -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  </head>

  <body class="bg-gradient-to-br from-indigo-100 via-fuchsia-100 to-sky-100">
    <div id="root"></div>

    <script type="text/babel">
      /****************************************************
       * 1) Pomocn√© funkce a konstanty (sd√≠len√©)
       ****************************************************/
      const { useState, useEffect, useMemo, useRef } = React;

      const toISO = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0, 10);
      const parseISO = (s) => { const [y,m,dd]=s.split('-').map(Number); return new Date(y, m-1, dd); };
      const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
      const addWeeks=(d,n)=>addDays(d,n*7);
      const startOfWeek=(d)=>{ const iso=d.getDay()||7; return addDays(new Date(d.getFullYear(),d.getMonth(),d.getDate()),-(iso-1)); };
      const isSameDay=(a,b)=>a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
      const fullDateCz=(d)=> d.toLocaleDateString('cs-CZ',{weekday:'long', day:'numeric', month:'long', year:'numeric'});
      const shortDateCz=(d)=> d.toLocaleDateString('cs-CZ',{day:'numeric', month:'numeric'});
      const cmpISO=(a,b)=>{ const A=parseISO(a), B=parseISO(b); if(A<B) return -1; if(A>B) return 1; return 0; };
      const diffDays=(aISO,bISO)=> Math.round((parseISO(aISO) - parseISO(bISO)) / 86400000);
      const schoolYearEndISO=(date)=>{ const y=date.getFullYear(); const m=date.getMonth(); const endYear=(m>=8? y+1:y); return new Date(endYear,5,30).toISOString().slice(0,10); };
      const PERIODS = ["0","1","2","3","4","5","6","7","8"];
      const STORAGE_KEY = "rezervace-chromebooku-state-v7";
      const uid=(p="id") => `${p}_${Math.random().toString(36).slice(2,10)}`;
      const Badge=({children,className=''})=> <span className={`inline-block text-[10px] px-1.5 py-0.5 rounded ${className}`}>{children}</span>;

      // V√ùSLEDN√â BARVY bunƒõk
      const CELLCLS = {
        free : 'bg-green-100 border border-green-400',
        single: 'bg-red-100 border border-red-400',
        recAmber: 'bg-amber-100 border border-amber-400',
        recBlue : 'bg-blue-100 border border-blue-400',
      };

      // V√ùCHOZ√ç offline data (kdy≈æ nen√≠ Firebase)
      const defaultState = {
        teachers: [{id:uid("t"), name:"Nov√°kov√°"},{id:uid("t"), name:"Dvo≈ô√°k"}],
        rooms: [
          {id:uid("r"), name:"IT uƒçebna", floor:"p≈ô√≠zem√≠", code:"IT", type:"room"},
          {id:uid("r"), name:"Voz√≠k 1", floor:"1. patro", code:"V1", type:"equipment", max:20},
          {id:uid("r"), name:"Druh√© patro", floor:"2. patro", code:"2P", type:"room"},
        ],
        reservations: {}, // 'YYYY-MM-DD': { [roomId]: { [period]: {teacherId,pieces?,note?, createdBy?} } }
        recurring: [],    // {id,roomId,period,teacherId,pieces?,note?, startISO, endISO?, mode, weeks?, allowElsewhere?, createdBy}
        users: [],        // jen pro offline vizualizaci
      };
      const loadLocal = ()=>{ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState; }catch{ return defaultState; } };
      const saveLocal = (s)=> localStorage.setItem(STORAGE_KEY, JSON.stringify(s));

      /****************************************************
       * 2) Firebase init (voliteln√©)
       ****************************************************/
      // DOPL≈á VLASTN√ç KONFIG, jinak z≈Østane offline re≈æim:
      const firebaseConfig = {
        // apiKey: "‚Ä¶",
        // authDomain: "‚Ä¶",
        // projectId: "‚Ä¶",
        // storageBucket: "‚Ä¶",
        // messagingSenderId: "‚Ä¶",
        // appId: "‚Ä¶",
      };

      let FB = null; // {app, auth, db} nebo null
      try {
        if (firebaseConfig && firebaseConfig.apiKey) {
          const app = firebase.initializeApp(firebaseConfig);
          const auth = firebase.auth();
          const db   = firebase.firestore();
          FB = { app, auth, db };
        }
      } catch(e){ console.warn("Firebase init error:", e); }

      /****************************************************
       * 3) Dialogy ‚Äì datum, m√≠stnost, rezervace
       ****************************************************/
      function DateModal({open,valueISO,onClose,onChange}) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">Vyber datum</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">‚úï</button>
              </div>
              <input type="date" className="w-full border rounded-xl px-3 py-2" value={valueISO} onChange={(e)=>onChange(e.target.value)}/>
              <div className="flex justify-end mt-3">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Hotovo</button>
              </div>
            </div>
          </div>
        );
      }

      function RoomDialog({open,initial,onClose,onSave}) {
        const [name,setName]=useState(""),[floor,setFloor]=useState(""),[code,setCode]=useState(""),
              [type,setType]=useState("room"),[max,setMax]=useState(1);
        useEffect(()=>{ if(open){ setName(initial?.name||""); setFloor(initial?.floor||""); setCode(initial?.code||""); setType(initial?.type||"room"); setMax(initial?.max||1);} },[open,initial]);
        if(!open) return null; const isEquip=type==="equipment";
        return(
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{initial?"Upravit m√≠stnost":"Nov√° m√≠stnost"}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">‚úï</button>
              </div>
              <div className="grid grid-cols-6 gap-2">
                <input className="col-span-3 border rounded-xl px-3 py-2" placeholder="N√°zev" value={name} onChange={e=>setName(e.target.value)}/>
                <input className="col-span-2 border rounded-xl px-3 py-2" placeholder="Patro" value={floor} onChange={e=>setFloor(e.target.value)}/>
                <input className="col-span-1 border rounded-xl px-3 py-2" placeholder="Zkratka" value={code} onChange={e=>setCode(e.target.value)}/>
                <select className="col-span-3 border rounded-xl px-3 py-2" value={type} onChange={e=>setType(e.target.value)}>
                  <option value="room">Uƒçebna</option>
                  <option value="equipment">Pom≈Øcka</option>
                </select>
                <input className="col-span-3 border rounded-xl px-3 py-2" type="number" min="1" placeholder="Max. kus≈Ø" value={max} onChange={e=>setMax(Number(e.target.value))} disabled={!isEquip}/>
              </div>
              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zru≈°it</button>
                <button onClick={()=>onSave({name,floor,code,type,max:isEquip?max:undefined})} className="px-3 py-2 rounded-xl bg-black text-white">Ulo≈æit</button>
              </div>
            </div>
          </div>
        );
      }

      function ReservationDialog({open,onClose,onSave,teachers,initial,room,editingRecurring}) {
        const [teacherId,setTeacherId]=useState(initial?.teacherId||teachers[0]?.id||"");
        const defaultPieces = room?.type === "equipment" ? (room?.max || 1) : 1;
        const [pieces,setPieces]=useState(initial?.pieces ?? defaultPieces);
        const [note,setNote]=useState(initial?.note||"");

        const isRoom = room?.type === "room";
        const [repeatOn, setRepeatOn] = useState(!!editingRecurring);
        const [repeatMode, setRepeatMode] = useState(editingRecurring?.mode || 'until'); // 'until' | 'weeks'
        const [repeatWeeks, setRepeatWeeks] = useState(editingRecurring?.weeks || 4);
        const [allowElsewhere, setAllowElsewhere] = useState(!!editingRecurring?.allowElsewhere && isRoom);

        useEffect(()=>{ if(open){ setPieces(initial?.pieces ?? defaultPieces); setRepeatOn(!!editingRecurring); setRepeatMode(editingRecurring?.mode || 'until'); setRepeatWeeks(editingRecurring?.weeks || 4); setAllowElsewhere(!!editingRecurring?.allowElsewhere && isRoom); } },[open,initial,room,editingRecurring]);

        if(!open) return null;
        const isEquip = room?.type==="equipment";
        const maxPieces=Math.max(1,room?.max||1);

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-4 max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-lg font-semibold">{editingRecurring?"Upravit opakov√°n√≠":"Nov√° rezervace"}</h3>
                <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100">‚úï</button>
              </div>

              <label className="block text-sm mb-2">Uƒçitel/ka
                <select className="w-full border rounded-xl px-3 py-2 mt-1" value={teacherId} onChange={e=>setTeacherId(e.target.value)}>
                  {teachers.map(t=><option key={t.id} value={t.id}>{t.name}</option>)}
                </select>
              </label>

              {isEquip && (
                <div className="mb-2">
                  <div className="flex justify-between text-xs text-gray-600">
                    <span>Poƒçet kus≈Ø</span><span>{pieces} / {maxPieces}</span>
                  </div>
                  <input type="range" min="1" max={maxPieces} value={pieces} onChange={(e)=>setPieces(Number(e.target.value))} className="w-full"/>
                </div>
              )}

              <label className="block text-sm">Pozn√°mka (volit.)
                <input className="w-full border rounded-xl px-3 py-2 mt-1" value={note} onChange={e=>setNote(e.target.value)}/>
              </label>

              {/* Opakov√°n√≠ */}
              <div className="mt-4 border-t pt-3">
                <div className="text-sm font-medium mb-2">Opakovat ka≈æd√Ω t√Ωden</div>
                <div className="inline-flex rounded-xl border overflow-hidden mb-3">
                  <button type="button" className={`px-3 py-1 ${!repeatOn ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatOn(false)}>Vypnuto</button>
                  <button type="button" className={`px-3 py-1 ${repeatOn ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatOn(true)}>Zapnuto</button>
                </div>

                {repeatOn && (
                  <div className="space-y-3">
                    <div className="text-sm">
                      <div className="mb-1">D√©lka opakov√°n√≠</div>
                      <div className="inline-flex rounded-xl border overflow-hidden">
                        <button type="button" className={`px-3 py-1 ${repeatMode==='until' ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatMode('until')}>Do konce roku</button>
                        <button type="button" className={`px-3 py-1 ${repeatMode==='weeks' ? 'bg-black text-white':'bg-white'}`} onClick={()=>setRepeatMode('weeks')}>Poƒçet t√Ωdn≈Ø</button>
                      </div>
                    </div>

                    {repeatMode==='weeks' && (
                      <label className="text-sm block">
                        <span className="block mb-1">Poƒçet t√Ωdn≈Ø</span>
                        <input type="number" min="1" max="40" className="w-full border rounded-xl px-3 py-2"
                          value={repeatWeeks} onChange={(e)=>setRepeatWeeks(Math.max(1,Math.min(40,Number(e.target.value)||1)))} />
                      </label>
                    )}

                    {isRoom && (
                      <div className="text-sm">
                        <div className="mb-1">M√≠sto kon√°n√≠</div>
                        <div className="inline-flex rounded-xl border overflow-hidden">
                          <button type="button" className={`px-3 py-1 ${!allowElsewhere ? 'bg-black text-white':'bg-white'}`} onClick={()=>setAllowElsewhere(false)}>Hodina mus√≠ b√Ωt v uƒçebnƒõ</button>
                          <button type="button" className={`px-3 py-1 ${allowElsewhere ? 'bg-black text-white':'bg-white'}`} onClick={()=>setAllowElsewhere(true)}>Hodina m≈Ø≈æe b√Ωt i jinde</button>
                        </div>
                        <div className="text-xs text-gray-600 mt-1">
                          {allowElsewhere ? 'Opakovan√© rezervace budou mod≈ôe.' : 'Opakovan√© rezervace budou ≈ælutƒõ.'}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-2 mt-4">
                <button onClick={onClose} className="px-3 py-2 rounded-xl border">Zru≈°it</button>
                <button
                  onClick={()=>{
                    onSave({
                      teacherId,
                      pieces: isEquip ? Number(pieces) : undefined,
                      note,
                      repeat: repeatOn ? {
                        mode: repeatMode,
                        weeks: repeatMode==='weeks' ? repeatWeeks : undefined,
                        allowElsewhere: isRoom ? allowElsewhere : undefined,
                      } : null,
                    });
                    onClose();
                  }}
                  className="px-3 py-2 rounded-xl bg-black text-white"
                >Ulo≈æit</button>
              </div>
            </div>
          </div>
        );
      }

      /****************************************************
       * 4) App ‚Äì s hybridn√≠m persistence layerem
       ****************************************************/
      function App(){
        const [selectedDate,setSelectedDate]=useState(new Date());
        const selectedIso = toISO(selectedDate);

        // Auth & role
        const [authUser,setAuthUser]=useState(null);      // Firebase user (nebo null)
        const [me,setMe]=useState(null);                  // Firestore users/{uid} ‚Äì {displayName,email,isAdmin,approved}
        const [loadingAuth,setLoadingAuth]=useState(!!FB);
        const [waitingApproval,setWaitingApproval]=useState(false);

        // Data (spoleƒçn√° API vrstva)
        const [rooms,setRooms]=useState(defaultState.rooms);
        const [teachers,setTeachers]=useState(defaultState.teachers); // v online re≈æimu = schv√°len√≠ u≈æivatel√©
        const [reservations,setReservations]=useState({}); // map roomId -> { period -> cell }
        const [recurring,setRecurring]=useState([]);
        const [allUsers,setAllUsers]=useState([]); // jen pro admin UI
        const [showSettings,setShowSettings]=useState(false);
        const [dateModal,setDateModal]=useState(false);
        const [editingRoom,setEditingRoom]=useState(null);
        const [creatingRoom,setCreatingRoom]=useState(false);
        const [dialog,setDialog]=useState(null); // {dateIso,roomId,period,initial?, editingRecurringId?}
        const [newTeacher,setNewTeacher]=useState("");

        // DnD pro m√≠stnosti
        const [dragRoomId, setDragRoomId] = useState(null);
        const [isDraggingRoom, setIsDraggingRoom] = useState(false);

        // Offline fallback state
        const offline = !FB;
        const [offlineState,setOfflineState]=useState(offline? loadLocal() : null);
        useEffect(()=>{ if(offline && offlineState){ saveLocal(offlineState); }},[offline,offlineState]);

        // ===== AUTH =====
        useEffect(()=>{
          if(!FB){ setLoadingAuth(false); return; }
          const unsub = FB.auth.onAuthStateChanged(async (u)=>{
            setAuthUser(u);
            if(!u){ setMe(null); setWaitingApproval(false); setLoadingAuth(false); return; }

            // vytvo≈ô/naƒçti sv≈Øj profil v /users/{uid}
            const ref = FB.db.collection('users').doc(u.uid);
            const doc = await ref.get();
            if(!doc.exists){
              await ref.set({
                email: u.email || '',
                displayName: u.displayName || (u.email? u.email.split('@')[0] : 'U≈æivatel'),
                isAdmin: false,
                approved: u.email === 'dgunka@gymnaziumbma.cz', // prvn√≠ admin = rovnou approved
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              }, {merge:true});
            }
            const snap = await ref.get();
            const data = snap.data();
            setMe(data);
            setWaitingApproval(!data.approved);
            setLoadingAuth(false);
          });
          return () => unsub && unsub();
        },[]);

        // ===== DATA ‚Äì online re≈æim: live listenery =====
        // uƒçitel√© = approved users
        useEffect(()=>{
          if(!FB || !me || waitingApproval) return;
          // list uƒçitel≈Ø (schv√°len√≠ u≈æivatel√©)
          const unsubUsers = FB.db.collection('users').onSnapshot((q)=>{
            const list = q.docs.map(d=>({id:d.id, ...d.data()}));
            setAllUsers(list);
            const allowed = list.filter(u=>u.approved);
            setTeachers(allowed.map(u=>({id:u.id, name: u.displayName || u.email})));
          });
          return () => unsubUsers && unsubUsers();
        },[!!FB, !!me, waitingApproval]);

        // rooms
        useEffect(()=>{
          if(!FB || !me || waitingApproval) return;
          const unsub = FB.db.collection('rooms').orderBy('name','asc').onSnapshot(q=>{
            setRooms(q.docs.map(d=>({id:d.id,...d.data()})));
          });
          return () => unsub && unsub();
        },[!!FB, !!me, waitingApproval]);

        // reservations pro vybran√Ω den
        useEffect(()=>{
          if(!FB || !me || waitingApproval) return;
          const unsub = FB.db.collection('reservations').where('dateISO','==',selectedIso).onSnapshot(q=>{
            const dayMap = {};
            q.docs.forEach(d=>{
              const r = d.data();
              dayMap[r.roomId] ??= {};
              dayMap[r.roomId][r.period] = { teacherId:r.teacherId, pieces:r.pieces, note:r.note, createdBy:r.createdBy };
            });
            setReservations(dayMap);
          });
          return () => unsub && unsub();
        },[!!FB, !!me, waitingApproval, selectedIso]);

        // recurring (cel√©; klient u≈æ filtruje occursOn)
        useEffect(()=>{
          if(!FB || !me || waitingApproval) return;
          const unsub = FB.db.collection('recurring').onSnapshot(q=>{
            setRecurring(q.docs.map(d=>({id:d.id, ...d.data()})));
          });
          return () => unsub && unsub();
        },[!!FB, !!me, waitingApproval]);

        // ===== DATA ‚Äì offline re≈æim: prom√≠tnout offlineState do stav≈Ø =====
        useEffect(()=>{
          if(!offline || !offlineState) return;
          setRooms(offlineState.rooms);
          setRecurring(offlineState.recurring);
          setTeachers(offlineState.teachers);
          setAllUsers(offlineState.users);
          setReservations(offlineState.reservations[selectedIso] || {});
        },[offline, offlineState, selectedIso]);

        // ===== Funkce occursOn =====
        function occursOn(dateISO, rec){
          if (cmpISO(dateISO, rec.startISO) < 0) return false;
          const days = diffDays(dateISO, rec.startISO);
          if (days % 7 !== 0) return false;
          if (rec.mode === 'weeks' && typeof rec.weeks === 'number'){
            const weekIndex = Math.floor(days / 7);
            return weekIndex >= 0 && weekIndex < rec.weeks;
          }
          if (rec.endISO && cmpISO(dateISO, rec.endISO) > 0) return false;
          return true;
        }

        // ===== Effective plan (merge jednor√°zov√© + opakovan√©) =====
        const effectivePlan = useMemo(()=>{
          const plan = JSON.parse(JSON.stringify(reservations || {}));
          (recurring || []).forEach(r=>{
            if(!occursOn(selectedIso, r)) return;
            plan[r.roomId] ??= {};
            if(!plan[r.roomId][r.period]){
              plan[r.roomId][r.period] = {
                teacherId: r.teacherId,
                pieces: r.pieces,
                note: r.note,
                recurringId: r.id,
                allowElsewhere: !!r.allowElsewhere,
                createdBy: r.createdBy,
              };
            }
          });
          return plan;
        }, [reservations, recurring, selectedIso]);

        // ===== T√Ωdenn√≠ panel ‚Äì p≈ôehled dne =====
        function daySummary(date){
          const iso = toISO(date), items=[], seen=new Set();
          const direct = (offline ? (offlineState?.reservations?.[iso] || {}) : {}) ;
          // online: vezmeme jen reservations pro selectedIso; pro ostatn√≠ dny zjednodu≈°en√© ‚Äî proto offline i online uk√°≈æeme jen recurring n√°hled
          Object.entries(direct).forEach(([roomId,slots])=>{
            Object.keys(slots).forEach(period=>{
              seen.add(`${roomId}|${period}`); items.push({period, code:(rooms.find(r=>r.id===roomId)?.code||"?"), kind:'single'});
            });
          });

          (recurring||[]).forEach(r=>{
            if(!occursOn(iso, r)) return;
            const key=`${r.roomId}|${r.period}`;
            if(seen.has(key)) return;
            items.push({period:r.period, code:(rooms.find(x=>x.id===r.roomId)?.code||"?"), kind: r.allowElsewhere ? 'rec-blue' : 'rec-amber'});
          });

          items.sort((a,b)=> Number(a.period)-Number(b.period) || a.code.localeCompare(b.code));
          return items;
        }

        // ===== CRUD ‚Äì rooms (admin) =====
        const addRoom = async (payload)=>{
          if(offline){
            setOfflineState(s=>({...s, rooms:[...s.rooms,{id:uid('r'),...payload}]}));
          } else {
            await FB.db.collection('rooms').add(payload);
          }
        };
        const updateRoom = async (id, patch)=>{
          if(offline){
            setOfflineState(s=>({...s, rooms:s.rooms.map(r=>r.id===id?{...r,...patch}:r)}));
          } else {
            await FB.db.collection('rooms').doc(id).set(patch, {merge:true});
          }
        };
        const removeRoom = async (id)=>{
          if(offline){
            setOfflineState(s=>({...s, rooms:s.rooms.filter(r=>r.id!==id)}));
          } else {
            await FB.db.collection('rooms').doc(id).delete();
          }
        };

        // ===== CRUD ‚Äì reservations/recurring =====
        async function upsertReservation(dateIso, roomId, period, payload, editingRecurringId=null){
          if(offline){
            setOfflineState(s=>{
              const next={...s, reservations:{...s.reservations}};
              const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
              day[roomId] ??= {};
              if(payload.repeat){
                if(day[roomId][period]) delete day[roomId][period];
              } else if (!editingRecurringId){
                day[roomId][period]={teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note, createdBy:'offline'};
              }
              next.reservations[dateIso]=day;

              if(payload.repeat || editingRecurringId){
                const orig = editingRecurringId ? s.recurring.find(r=>r.id===editingRecurringId) : null;
                const seriesStartISO = orig ? orig.startISO : dateIso;
                let rec = {
                  roomId, period, teacherId:payload.teacherId, pieces:payload.pieces, note:payload.note,
                  startISO: seriesStartISO,
                  allowElsewhere: (payload.repeat?.allowElsewhere===true) ? true : undefined,
                  createdBy: 'offline',
                };
                if(payload.repeat){
                  if(payload.repeat.mode==='until'){ rec.mode='until'; rec.endISO=schoolYearEndISO(parseISO(seriesStartISO)); rec.weeks=undefined; }
                  else { const w=Math.max(1,Number(payload.repeat.weeks)||1); rec.mode='weeks'; rec.weeks=w; rec.endISO=toISO(addWeeks(parseISO(seriesStartISO), w-1)); }
                }
                if(editingRecurringId){
                  if(!payload.repeat){ next.recurring = s.recurring.filter(r=>r.id!==editingRecurringId); }
                  else { rec.id=editingRecurringId; next.recurring = s.recurring.map(r=>r.id===editingRecurringId? {...r, ...rec}: r); }
                } else { rec.id = uid('rec'); next.recurring=[...s.recurring, rec]; }
              }
              return next;
            });
          } else {
            // online
            const userId = FB.auth.currentUser?.uid || 'unknown';
            if(payload.repeat || editingRecurringId){
              const origSnap = editingRecurringId ? await FB.db.collection('recurring').doc(editingRecurringId).get() : null;
              const seriesStartISO = (origSnap && origSnap.exists) ? origSnap.data().startISO : dateIso;

              if(payload.repeat){
                // zajist√≠me single-slot v den startu: nechceme "duplik√°t" pokud s√©rie existuje
                const daySnap = await FB.db.collection('reservations')
                  .where('dateISO','==', dateIso)
                  .where('roomId','==', roomId)
                  .where('period','==', period)
                  .get();
                daySnap.forEach(d=> d.ref.delete());

                const rec = {
                  roomId, period, teacherId: payload.teacherId, pieces: payload.pieces, note: payload.note,
                  startISO: seriesStartISO,
                  allowElsewhere: (payload.repeat?.allowElsewhere===true) ? true : firebase.firestore.FieldValue.delete(),
                  createdBy: userId, updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                };
                if(payload.repeat.mode==='until'){
                  rec.mode='until'; rec.endISO=schoolYearEndISO(parseISO(seriesStartISO)); rec.weeks = firebase.firestore.FieldValue.delete();
                } else {
                  const w = Math.max(1, Number(payload.repeat.weeks)||1);
                  rec.mode='weeks'; rec.weeks=w; rec.endISO = toISO(addWeeks(parseISO(seriesStartISO), w-1));
                }
                if(editingRecurringId){
                  await FB.db.collection('recurring').doc(editingRecurringId).set(rec, {merge:true});
                } else {
                  rec.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                  await FB.db.collection('recurring').add(rec);
                }
              } else {
                // vypnuto opakov√°n√≠ -> sma≈æ s√©rii
                if(editingRecurringId){
                  await FB.db.collection('recurring').doc(editingRecurringId).delete();
                }
                // vytvo≈ô single slot
                await FB.db.collection('reservations').add({
                  dateISO: dateIso, roomId, period,
                  teacherId: payload.teacherId, pieces: payload.pieces, note: payload.note,
                  createdBy: userId, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
              }
            } else {
              // jednor√°zov√° rezervace
              await FB.db.collection('reservations').add({
                dateISO: dateIso, roomId, period,
                teacherId: payload.teacherId, pieces: payload.pieces, note: payload.note,
                createdBy: userId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
            }
          }
        }

        async function clearReservation(dateIso,roomId,period){
          if(offline){
            setOfflineState(s=>{
              const next={...s, reservations:{...s.reservations}};
              const day = JSON.parse(JSON.stringify(next.reservations[dateIso]||{}));
              if(day[roomId]) delete day[roomId][period];
              next.reservations[dateIso]=day;
              return next;
            });
          } else {
            const q = await FB.db.collection('reservations')
              .where('dateISO','==', dateIso)
              .where('roomId','==', roomId)
              .where('period','==', period)
              .get();
            for(const d of q.docs) await d.ref.delete();
          }
        }

        async function stopRecurring(id){
          if(offline){
            setOfflineState(s=>({...s, recurring:s.recurring.filter(r=>r.id!==id)}));
          } else {
            await FB.db.collection('recurring').doc(id).delete();
          }
        }

        // ===== UI hlaviƒçka (login/out) =====
        const canUseApp = offline || (!!authUser && !!me && me.approved);
        const isAdmin = offline ? true : !!me?.isAdmin; // offline v≈°echno dovoleno

        // ===== WORKWEEK =====
        const workweek = useMemo(()=>{
          const start = startOfWeek(selectedDate);
          return [0,1,2,3,4].map(off=>addDays(start,off));
        }, [selectedDate]);

        // ===== Render ‚Äì r≈Øzn√© stavy auth =====
        if(FB && loadingAuth){
          return <div className="max-w-3xl mx-auto p-8">Naƒç√≠t√°m p≈ôihl√°≈°en√≠‚Ä¶</div>;
        }
        if(FB && !authUser){
          return (
            <div className="min-h-[70vh] flex items-center justify-center p-6">
              <div className="bg-white/80 rounded-2xl shadow p-6 max-w-md w-full">
                <h1 className="text-2xl font-bold mb-4">Rezervace Chromebook≈Ø a uƒçeben</h1>
                <p className="mb-4 text-gray-700">Pro pokraƒçov√°n√≠ se p≈ôihlas sv√Ωm Google √∫ƒçtem.</p>
                <button
                  className="px-4 py-2 rounded-xl bg-black text-white w-full"
                  onClick={()=> FB.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())}
                >P≈ôihl√°sit se Googlem</button>
                <p className="mt-3 text-xs text-gray-500">Offline m√≥d: pokud nevypln√≠≈° Firebase config, aplikace bƒõ≈æ√≠ bez p≈ôihl√°≈°en√≠ (doƒçasnƒõ).</p>
              </div>
            </div>
          );
        }
        if(FB && authUser && !canUseApp){
          return (
            <div className="min-h-[70vh] flex items-center justify-center p-6">
              <div className="bg-white/80 rounded-2xl shadow p-6 max-w-md w-full">
                <h1 className="text-2xl font-bold mb-2">√öƒçet ƒçek√° na schv√°len√≠</h1>
                <p className="text-gray-700">Tento √∫ƒçet zat√≠m nen√≠ schv√°len√Ω administr√°torem.</p>
                <div className="mt-4 text-sm text-gray-600">
                  P≈ôihl√°≈°en: {authUser.email}
                </div>
                <div className="mt-6 flex gap-2">
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>FB.auth.signOut()}>Odhl√°sit</button>
                </div>
              </div>
            </div>
          );
        }

        // ===== DENN√ç TABULKA ‚Äì kliky =====
        const openCell = (room, period)=>{
          const cell = effectivePlan?.[room.id]?.[period];
          if(cell){
            if(cell.recurringId){
              const rec = recurring.find(r=>r.id===cell.recurringId);
              setDialog({dateIso:selectedIso, roomId:room.id, period, initial:cell, editingRecurringId: rec?.id});
            } else {
              setDialog({dateIso:selectedIso, roomId:room.id, period, initial:cell});
            }
          } else {
            setDialog({dateIso:selectedIso, roomId:room.id, period});
          }
        };

        /*********************
         * Vykreslen√≠ APP
         *********************/
        return (
          <div className="p-4 max-w-7xl mx-auto grid gap-4">
            {/* horn√≠ li≈°ta */}
            <header className="flex items-center justify-between">
              <h1 className="text-2xl font-bold">Rezervace Chromebook≈Ø a uƒçeben</h1>
              <div className="flex items-center gap-2">
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,-1))} className="px-3 py-2 rounded-xl border bg-white">‚óÄ T√Ωden</button>
                <button onClick={()=>setDateModal(true)} className="px-3 py-2 rounded-xl border bg-white">üìÖ Datum</button>
                <button onClick={()=>setSelectedDate(addWeeks(selectedDate,1))} className="px-3 py-2 rounded-xl border bg-white">T√Ωden ‚ñ∂</button>
                <button onClick={()=>setShowSettings(s=>!s)} className="px-3 py-2 rounded-xl border bg-white">{showSettings?'Skr√Ωt nastaven√≠':'Nastaven√≠'}</button>
                {FB && authUser && (
                  <button onClick={()=>FB.auth.signOut()} className="px-3 py-2 rounded-xl border bg-white">Odhl√°sit</button>
                )}
              </div>
            </header>

            {/* modal datum */}
            <DateModal open={dateModal} valueISO={toISO(selectedDate)} onClose={()=>setDateModal(false)} onChange={(v)=>v&&setSelectedDate(parseISO(v))}/>

            {/* pracovn√≠ t√Ωden ‚Äì mobiln√≠ horizont√°ln√≠ scroll */}
            <section className="bg-white/80 rounded-2xl p-4">
              <div className="hidden sm:grid grid-cols-5 text-center text-xs font-medium text-gray-600 mb-2">{["Po","√öt","St","ƒåt","P√°"].map((n,i)=><div key={i} className="py-1">{n}</div>)}</div>
              <div className="sm:grid sm:grid-cols-5 gap-2 flex overflow-x-auto -mx-2 px-2">
                {workweek.map(d=>{
                  const sel=isSameDay(d,selectedDate), items=daySummary(d);
                  return(
                    <button key={d.toISOString()} onClick={()=>setSelectedDate(d)} className={`sm:h-28 h-24 sm:w-auto w-40 shrink-0 rounded-2xl border p-2 text-left bg-white hover:shadow ${sel?'ring-2 ring-fuchsia-400':''}`}>
                      <div className="text-sm font-semibold">{shortDateCz(d)}</div>
                      <div className="mt-1 flex flex-wrap gap-1">
                        {items.length===0?<Badge className="bg-green-100 border border-green-400 text-green-800">volno</Badge>:
                          items.map((it,idx)=>{
                            const cls = it.kind==='single' ? "bg-red-100 border border-red-400 text-red-800"
                                      : it.kind==='rec-blue' ? "bg-blue-100 border border-blue-400 text-blue-800"
                                      : "bg-amber-100 border border-amber-400 text-amber-900";
                            return <Badge key={idx} className={cls}>{it.period}. {it.code}</Badge>;
                          })
                        }
                      </div>
                    </button>
                  );
                })}
              </div>
            </section>

            {/* denn√≠ pl√°n */}
            <section className="bg-white/80 rounded-2xl p-4">
              <h2 className="text-lg font-semibold mb-2">{fullDateCz(selectedDate)}</h2>
              <div className="-mx-2 sm:mx-0 overflow-x-auto">
                <div className="min-w-[900px]">
                  <table className="w-full text-sm">
                    <thead><tr><th className="text-left p-2 sticky left-0 bg-white/90 backdrop-blur z-10">Uƒçebna</th>{PERIODS.map(p=><th key={p} className="p-2 min-w-28 text-center">{p}. hod.</th>)}</tr></thead>
                    <tbody>
                      {rooms.map(room=>(
                        <tr key={room.id} className="odd:bg-white/60 even:bg-white/40">
                          <th className="text-left p-2 sticky left-0 bg-white/80 backdrop-blur z-10">
                            <div className="font-medium">{room.name}</div>
                            <div className="mt-0.5 flex gap-2 items-center text-xs text-gray-700">
                              <span className="px-1.5 py-0.5 rounded bg-gray-100 border">{room.floor}</span>
                            </div>
                          </th>
                          {PERIODS.map(p=>{
                            const cell = effectivePlan?.[room.id]?.[p];
                            const isRecurring=!!cell?.recurringId;
                            const recurringBlue = isRecurring && cell?.allowElsewhere;
                            const cls = !cell ? CELLCLS.free
                                      : isRecurring ? (recurringBlue ? CELLCLS.recBlue : CELLCLS.recAmber)
                                      : CELLCLS.single;
                            const canDelete = offline ? true : (isAdmin || (cell?.createdBy && authUser?.uid && cell.createdBy===authUser.uid));
                            return (
                              <td key={p} className="align-top p-1">
                                <div className={`rounded-xl p-2 min-h-16 ${cls}`} onClick={()=>openCell(room,p)}>
                                  {cell?(
                                    <div className="flex flex-col gap-1">
                                      <div className="font-medium flex items-center gap-2">
                                        { (teachers.find(t=>t.id===cell.teacherId)?.name) || '‚Äî' }
                                        { cell.pieces ? <Badge className="bg-white/70 border text-xs">{cell.pieces} ks</Badge> : null }
                                      </div>
                                      {cell.note && <div className="text-xs">{cell.note}</div>}
                                      <div className="flex gap-2 mt-1">
                                        {isRecurring ? (
                                          <button className="px-2 py-1 rounded-lg border text-xs" onClick={(e)=>{e.stopPropagation(); stopRecurring(cell.recurringId);}}>Zru≈°it opak.</button>
                                        ): canDelete ? (
                                          <button className="px-2 py-1 rounded-lg border text-xs" onClick={(e)=>{e.stopPropagation(); clearReservation(selectedIso,room.id,p);}}>Smazat</button>
                                        ) : null}
                                      </div>
                                    </div>
                                  ) : <span className="w-full text-left text-xs block text-green-900">+ P≈ôidat</span>}
                                </div>
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </section>

            {/* nastaven√≠ */}
            {showSettings && (
              <section className="bg-white/80 rounded-2xl p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div>
                  <h2 className="text-lg font-semibold mb-2">Uƒçitel√©</h2>
                  {/* offline jednoduch√Ω seznam; online = users */}
                  {offline && (
                    <>
                      <div className="flex gap-2 mb-3">
                        <input className="flex-1 border rounded-xl px-3 py-2" placeholder="Jm√©no a p≈ô√≠jmen√≠" value={newTeacher} onChange={e=>setNewTeacher(e.target.value)}/>
                        <button onClick={()=>{ if(newTeacher.trim()){ setOfflineState(s=>({...s, teachers:[...s.teachers,{id:uid('t'), name:newTeacher.trim()}]})); setNewTeacher(''); }}} className="px-3 py-2 rounded-xl bg-black text-white">P≈ôidat</button>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {teachers.map(t=>(
                          <span key={t.id} className="inline-flex items-center gap-2 px-3 py-1 rounded-full border">
                            {t.name}
                            <button className="text-red-600" onClick={()=> setOfflineState(s=>({...s, teachers:s.teachers.filter(x=>x.id!==t.id)}))}>‚úï</button>
                          </span>
                        ))}
                      </div>
                    </>
                  )}
                  {!offline && (
                    <div className="text-sm text-gray-600">Seznam uƒçitel≈Ø je odvozen ze schv√°len√Ωch u≈æivatel≈Ø (viz ‚ÄûU≈æivatel√©‚Äú).</div>
                  )}
                </div>

                <div>
                  <h2 className="text-lg font-semibold mb-2">Uƒçebny / Pom≈Øcky</h2>
                  {isAdmin ? (
                    <>
                      <div className="flex gap-2 mb-3">
                        <button className="px-3 py-2 rounded-xl bg-black text-white" onClick={()=>setCreatingRoom(true)}>P≈ôidat</button>
                      </div>
                      <div className="flex flex-col gap-2">
                        {rooms.map(r=>(
                          <div key={r.id}
                            className="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2 cursor-move select-none"
                            draggable
                            onDragStart={()=>{ setDragRoomId(r.id); setIsDraggingRoom(true); }}
                            onDragEnd={()=>{ setIsDraggingRoom(false); setDragRoomId(null); }}
                            onDragOver={(e)=>e.preventDefault()}
                            onDrop={async ()=>{
                              if(!dragRoomId || dragRoomId===r.id) return;
                              // offline: reorder lok√°lnƒõ, online: jen UI reorder (server po≈ôad√≠ ne≈ôe≈°√≠me)
                              const reorder = (arr, fromId, toId)=>{
                                const copy=[...arr];
                                const from = copy.findIndex(x=>x.id===fromId);
                                const to   = copy.findIndex(x=>x.id===toId);
                                if(from<0||to<0) return arr;
                                const [m] = copy.splice(from,1);
                                copy.splice(to,0,m);
                                return copy;
                              };
                              if(offline){
                                setOfflineState(s=>({...s, rooms: reorder(s.rooms, dragRoomId, r.id)}));
                              } else {
                                setRooms(prev=>reorder(prev, dragRoomId, r.id));
                              }
                              setIsDraggingRoom(false); setDragRoomId(null);
                            }}
                            onClick={()=>{ if(!isDraggingRoom) setEditingRoom(r); }}
                          >
                            <div>
                              <div className="font-medium">{r.name}</div>
                              <div className="mt-0.5 flex gap-2 items-center text-xs text-gray-700">
                                <span className="px-1.5 py-0.5 rounded bg-gray-100 border">{r.code}</span>
                                <span className="px-1.5 py-0.5 rounded bg-gray-100 border">{r.floor}</span>
                                <span className="px-1.5 py-0.5 rounded bg-gray-100 border">{r.type==='equipment' ? `pom≈Øcka${r.max?` ‚Ä¢ max ${r.max}`:''}` : 'uƒçebna'}</span>
                              </div>
                            </div>
                            <button className="text-red-600 px-2 py-1 rounded-full hover:bg-red-50" title="Odebrat" onClick={(e)=>{ e.stopPropagation(); removeRoom(r.id); }}>‚úï</button>
                          </div>
                        ))}
                      </div>
                    </>
                  ) : (
                    <div className="text-sm text-gray-600">Nastaven√≠ uƒçeben je dostupn√© pouze administr√°tor≈Øm.</div>
                  )}
                </div>

                <div>
                  <h2 className="text-lg font-semibold mb-2">U≈æivatel√©</h2>
                  {isAdmin ? (
                    <>
                      <div className="text-xs text-gray-600 mb-2">Zde schvaluj a nastavuj role. P≈ôid√°n√≠ ‚Äûnaneƒçisto‚Äú vytvo≈ô√≠ z√°znam, ale u≈æivatel se stejnƒõ mus√≠ p≈ôihl√°sit Googlem.</div>
                      {!offline && (
                        <div className="space-y-2">
                          {allUsers.map(u=>(
                            <div key={u.id} className="flex items-center justify-between rounded-xl border bg-white px-3 py-2">
                              <div className="text-sm">
                                <div className="font-medium">{u.displayName || u.email}</div>
                                <div className="text-xs text-gray-600">{u.email}</div>
                              </div>
                              <div className="flex items-center gap-2 text-sm">
                                <label className="inline-flex items-center gap-1">
                                  <input type="checkbox" checked={!!u.approved} onChange={async (e)=> await FB.db.collection('users').doc(u.id).set({approved:e.target.checked},{merge:true})}/>
                                  schv√°len
                                </label>
                                <label className="inline-flex items-center gap-1">
                                  <input type="checkbox" checked={!!u.isAdmin} onChange={async (e)=> await FB.db.collection('users').doc(u.id).set({isAdmin:e.target.checked},{merge:true})}/>
                                  admin
                                </label>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                      {offline && <div className="text-sm text-gray-600">V offline re≈æimu spr√°va u≈æivatel≈Ø nebƒõ≈æ√≠.</div>}
                    </>
                  ) : (
                    <div className="text-sm text-gray-600">Spr√°vu u≈æivatel≈Ø vid√≠ pouze administr√°to≈ôi.</div>
                  )}
                </div>
              </section>
            )}

            {/* dialogy */}
            <ReservationDialog
              open={!!dialog}
              onClose={()=>setDialog(null)}
              teachers={teachers}
              initial={dialog?.initial}
              room={rooms.find(r=>r.id===dialog?.roomId)}
              editingRecurring={dialog?.editingRecurringId ? recurring.find(r=>r.id===dialog.editingRecurringId) : null}
              onSave={(payload)=> upsertReservation(dialog.dateIso, dialog.roomId, dialog.period, payload, dialog?.editingRecurringId||null)}
            />
            <RoomDialog
              open={!!editingRoom}
              initial={editingRoom}
              onClose={()=>setEditingRoom(null)}
              onSave={async (patch)=>{ await updateRoom(editingRoom.id, patch); setEditingRoom(null); }}
            />
            <RoomDialog
              open={creatingRoom}
              initial={null}
              onClose={()=>setCreatingRoom(false)}
              onSave={async (patch)=>{ await addRoom(patch); setCreatingRoom(false); }}
            />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
